<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
<title>Puppet Modules Standards and Interoperability</title>
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow">
<!-- style sheet links -->
<link rel="stylesheet" href="puppetmodules.css" type="text/css" media="projection" id="slideProj">
<link rel="stylesheet" href="shared/outline.css" type="text/css" media="screen" id="outlineStyle">
<link rel="stylesheet" href="shared/print.css" type="text/css" media="print" id="slidePrint">

<!-- S6 JS -->
<script src="shared/jquery.js" type="text/javascript"></script>
<script src="shared/slides.js" type="text/javascript"></script>
<style type="text/css">
<!--
.style2 {color: #FF0000}
.style3 {color: #0000FF}
-->
</style>
<script type="text/javascript">
<!--
function MM_preloadImages() { //v3.0
  var d=document; if(d.images){ if(!d.MM_p) d.MM_p=new Array();
    var i,j=d.MM_p.length,a=MM_preloadImages.arguments; for(i=0; i<a.length; i++)
    if (a[i].indexOf("#")!=0){ d.MM_p[j]=new Image; d.MM_p[j++].src=a[i];}}
}

function MM_swapImgRestore() { //v3.0
  var i,x,a=document.MM_sr; for(i=0;a&&i<a.length&&(x=a[i])&&x.oSrc;i++) x.src=x.oSrc;
}

function MM_findObj(n, d) { //v4.01
  var p,i,x;  if(!d) d=document; if((p=n.indexOf("?"))>0&&parent.frames.length) {
    d=parent.frames[n.substring(p+1)].document; n=n.substring(0,p);}
  if(!(x=d[n])&&d.all) x=d.all[n]; for (i=0;!x&&i<d.forms.length;i++) x=d.forms[i][n];
  for(i=0;!x&&d.layers&&i<d.layers.length;i++) x=MM_findObj(n,d.layers[i].document);
  if(!x && d.getElementById) x=d.getElementById(n); return x;
}

function MM_swapImage() { //v3.0
  var i,j=0,x,a=MM_swapImage.arguments; document.MM_sr=new Array; for(i=0;i<(a.length-2);i+=3)
   if ((x=MM_findObj(a[i]))!=null){document.MM_sr[j++]=x; if(!x.oSrc) x.oSrc=x.src; x.src=a[i+2];}
}
//-->
</script>
</head>
<body onLoad="MM_preloadImages('gfx/min-dart.jpg')">

<div class="layout">
<!--  
  <div class="background">  
    <object data="puppetmodules.svg" width="100%" height="100%"></object>
  </div>   
-->
<div id="controls"><!-- DO NOT EDIT --></div>
<div id="currentSlide"><!-- DO NOT EDIT --></div>
<div id="header"></div>
<div id="footer"><a href="http://www.lab42.it/en"><img src="gfx/footer.png" alt="Footer" border="0"></a></div>
</div>

<div class="presentation">

  <!-- add slides here; example -->

<div class='slide'>
	<h1 style="visibility:hidden; display:none">Puppet Modules Standards and Interoperability</h1>
    <div align="center"><img src="gfx/part-0.jpg" alt="Opening">
    </div>
</div>

<div class='slide'>
	<h1 style="visibility:hidden; display:none" >Part 1 - Evolution of species</h1>
    <img src="gfx/part-1.jpg" alt="Part 1" class="picpart">
</div>

<div class='slide'>
	<h1>First there were recipes...</h1>
    <img src="gfx/min-uova.jpg" class="pic">
	<ul class='step'>
		<li>Unstructured manifests and files</li>
		<li>Useful for learning and customizing</li>
		<li>Generally tuned for specific OS and environments</li>
		<li>Limited reusability (a notable exception: SSH::auth)</li>
	</ul>
</div>

<div class='slide'>
	<h1>Then came modules ...</h1>
    <img src="gfx/min-cuscino.jpg" class="pic">
	<ul class='step'>
		<li>Standard structure</li>
		<li>Reusable (not always)</li>
		<li>Intended to be cross OS (not always)</li>
		<li>Intended to be "Plug & Play" (hardly)</li>
	</ul>
</div>

<div class='slide'>
	<h1>From modules to collections ...</h1>
    <p>Complete sets of modules</p>
    <img src="gfx/min-divano.jpg" class="pic">
	<ul class='step'>
		<li>Ready to use and customize</li>
		<li>Generally based on a specific OS</li>
		<li>Internal coherency, logic and design</li>
		<li>Use of custom types and functions</li>
		<li>Difficult to cherry pick single modules</li>
		<li>Low interoperability among different collections</li>
	</ul>
</div>

<div class='slide'>
	<h1>Collections' parallel universes</h1>
    <img src="gfx/min-peng.jpg" class="pic">
	<ul class='step'>
		<li><strong>David Schmitt’s Complete Configuration</strong><br>
	      <a href="http://git.black.co.at" target="_blank">http://git.black.co.at</a></li>
		<li><strong>CamptoCamp</strong><br>
	      <a href="http://github.com/camptocamp" target="_blank">http://github.com/camptocamp</a></li>
		<li><strong>Immerda</strong><br>
	      <a href="http://git.puppet.immerda.ch" target="_blank">http://git.puppet.immerda.ch</a></li>
		<li><strong>PuppetManaged</strong><br>
	      <a href="http://puppetmanaged.org" target="_blank">http://puppetmanaged.org</a></li>
		<li><strong>Puzzle</strong><br>
	      <a href="http://puppet-modules.git.puzzle.ch" target="_blank">http://puppet-modules.git.puzzle.ch</a></li>
		<li><strong>Example42</strong><br>
	      <a href="http://www.example42.com" target="_blank">http://www.example42.com</a><br>
	  </li>
	</ul>
    	  <p>Complete list on Puppet's <a href="http://projects.reductivelabs.com/projects/puppet/wiki/Puppet_Modules">wiki</a></p>
</div>

<div class='slide'>
	<h1>May the Forge be with You!</h1>
    <img src="gfx/min-joda.jpg" class="pic" id="forge" onMouseOver="MM_swapImage('forge','','gfx/min-dart.jpg',1)" onMouseOut="MM_swapImgRestore()">
	<p>Puppet Modules Forge</p>
	<ul class='step'>
		<li>Central repository of modules</li>
		<li>Name based hierarchy</li>
		<li>Easily usable and pluggable (?)</li>
		<li>Embedded in Puppet's tools set</li>
	    <li>Future integration with external node tools (Dashboard)</li>
	    <li>Automatic Metadata management</li>
	</ul>
</div>

<div class='slide'>
	<h1>From Caos to Revelation</h1>
    <img src="gfx/min-formaggio.jpg" class="pic">    
    <p>"<em>Let's put stuff together and see what happens</em>"</p>
    <p>&nbsp;</p>
    <p>The road seems clear,<br>
      PuppetLabs defines it<br>
    We may forge it.</p>
</div>

<div class='slide'>
	<h1 style="visibility:hidden; display:none" >Part 2 - Who Said Standards?</h1>
    <img src="gfx/part-2.jpg" alt="Part 2" class="picpart">
</div>

<div class='slide'>
	<h1>Conventions</h1>
	<ul class='step'>
		<li>Name of application = name of module</li>
		<li>Module name should be lowercase without space, :: and /</li>
		<li>Module name "<strong>site</strong>" is reserved for local use<br>
		  <br>
		</li>
		<li>include postfix - Installs and runs the Postfix service</li>
		<li>include postfix::disable - Installs Postfix but doesn't run the service<br>
		  <br>
		</li>
        <li>include samba::server - Installs Samba server</li>
	    <li>include samba::client - Installs Samba client</li>
    </ul>
    <ul class='step'>
      <li><strong>import autofs - </strong>Loads <strong>$modulepath/autofs/manifests/init.pp</strong></li>
  <li><strong>include autofs::server</strong> - Loads <strong>$modulepath/autofs/manifests/server.pp</strong></li>
    </ul>
    <p>&nbsp;</p>
</div>


</div>

<div class='slide'>
	<h1>Modules path and structure</h1>
<p>Where to place modules:
<pre>
[root@localhost ~]# puppetmasterd --genconfig | grep modulepath
modulepath = <strong>/etc/puppet/modules:/usr/share/puppet/modules</strong>
</pre>
</p>

<p>How files are organized in a module:
<pre>
$modulepath/
   downcased_module_name/
      tests/
         init.pp
      files/
      manifests/
         init.pp
      lib/
         puppet/
            parser/
               functions
            provider/
            type/
         facter/
      templates/
      metadata.json
      README
</pre>
</p>
<p>Notes: <br />
- lib was plugins on Puppet &lt; 0.25<br />
- depends/ directory is obsolete</p>
<p>&nbsp;</p>
</div>

<div class='slide'>
	<h1>Referring to managed files</h1>

<p>Static source files or templates:</p>
<pre>
class autofs::client {
  package { autofs: ensure =&gt; latest }
  service { autofs: ensure =&gt; running }
  file { "/etc/auto.homes":
    <span class="style2">source =&gt; "puppet://$servername/<strong>modules</strong>/autofs/auto.homes"</span>
  }
  file { "/etc/auto.master":
    <span class="style3">content =&gt; template("autofs/auto.master.erb")</span>
  }
}
</pre>

<p>Sourced files are searched in:
<pre><span class="style2">$modulepath/autofs/files/auto.homes</span></pre></p>
<p>Templates are searched in:
<pre><span class="style3">$templatedir/autofs/auto.master.erb
$modulepath/autofs/templates/auto.master.erb</span></p>
</pre>
</div>


<div class='slide'>
	<h1>Modules documentation</h1>

<p><strong>Puppetdoc</strong> generates documentation from manifests comments:</p>
<pre>
$ puppetdoc [--all] --mode rdoc [--outputdir <path-spec>] [--debug|--verbose] [--trace]
            [--modulepath <path-list>] [--manifestdir <path-spec>] [--config <file-spec>]
</pre>
<p> Comment classes as below:</p>
<pre>
# Class: apache
#
# This module manages Apache
#
# Parameters:
#
# Actions:
#
# Requires:
#
# Sample Usage:
#
# [Remember: No empty lines between comments and class definition]
class apache {
	...
}

</pre>
</div>


<div class='slide'>
	<h1>Supporting different OS: <br />Dedicated sub classes</h1>
  <p>Minor differences can be managed in the same class:</p>
<pre>
class apache {
    [...]
    package { apache:
        name   => "${apache::params::packagename}",
        ensure => present,
    }
}
</pre>
  <p>Major differences are managed in dedicated (autoloaded) classes:</p>
<pre>
class apache {
    [...]
    case $operatingsystem {
        debian: { include apache::debian }
        ubuntu: { include apache::debian }
        default: { }
    }
}
</pre>
</div>


<div class='slide'>
	<h1>Supporting different OS: <br />Centralize internal variables</h1>
  <p>A class where to place all the internal variables of a <strong>module::params</strong></p>
<pre>
class apache::params  {

    $packagename = $operatingsystem ? {
        freebsd => "apache20",
        debian  => "apache2",
        ubuntu  => "apache2",
        default => "httpd",
    }
    
    $servicename = $operatingsystem ? {
        debian  => "apache2",
        ubuntu  => "apache2",
        default => "httpd",
    }
    
    $username = $operatingsystem ? {
        debian  => "www-data",
        ubuntu  => "www-data",
        default => "apache",
    }
    
    $configfile = $operatingsystem ?{
        freebsd => "/usr/local/etc/apache20/httpd.conf",
        ubuntu  => "/etc/apache2/apache2.conf",
        debian  => "/etc/apache2/apache2.conf",
        default => "/etc/httpd/conf/httpd.conf",
    }
    
    $configdir = $operatingsystem ?{
        freebsd => "/usr/local/etc/apache20",
        ubuntu  => "/etc/apache2",
        debian  => "/etc/apache2",
        default => "/etc/httpd/conf",
    }
    
    $documentroot = $operatingsystem ?{
        debian  => "/var/www",
        ubuntu  => "/var/www",
        suse    => "/srv/www",
        default => "/var/www/html",
    }

}

</pre>
</div>

<div class='slide'>
	<h1>Anatomy of a reusable module<img src="gfx/discute.gif" class="discute"></h1>
    <img src="gfx/min-pugno.jpg" class="pic">
    <ul class='step'>
	    <li>Can be included <em>as is</em> to provide standard service</li>
        <li>Eases customizations without direct modification of its contents</li>
        <li>May suggest, but not  force, the logic for files provisioning</li>
        <li>Provides, when needed, autonomous custom types, facts, functions</li>
        <li>Documents the external custom types/facts/functions it needs</li>
        <li>Has defaults for the needed variables</li>
    </ul>    
</div>


<div class='slide'>
	<h1>Managing variables and files<img src="gfx/discute.gif" class="discute"></h1>
	<p>Alternatives for managing user variables:</p>
    <ul class='step'>
	    <li>Required variables are provided by an external node tool</li>
        <li>Variables are defined at node level, according to a node inheritance tree</li>
        <li>Variables are defined in <em>configuration</em> classes, included by nodes</li>
        <li>No custom variables, only facts</li>
        <li>Variables are defined in an external data source (See: <strong><a href="http://www.devco.net/archives/2009/08/31/complex_data_and_puppet.php#comments" target="_blank">extlookup</a></strong>)</li>
    </ul>    

	<p>Alternatives for providing configuration files:</p>
    <ul class='step'>
	    <li>Provide static files, sourced according to a defined path hierarchy</li>
	    <li>Provide templates based on user variables</li>
        <li>Build files from fragments (Using custom types like <strong><a href="http://www.devco.net/archives/2010/02/19/building_files_from_fragments_with_puppet.php" target="_blank">concat</a></strong> )</li>
        <li>Files' contents are managed via the Augeas type</li>
        <li>Files' inline modifications are done with custom types</li>
	</ul>
</div>


<div class='slide'>
	<h1>Customizing modules<img src="gfx/discute.gif" class="discute"></h1>
	<p>Customization without module modification:</p>
    <ul class='step'>
	    <li>+ Module can be reused and shared among different projects</li>
        <li>+ Module can be easily synced with its mainstream source</li>
        <li>- Stick to module's logic or apply modifications form an external module</li>
        <li>- Modifications must be done on subclasses that inherit or include module's classes</li>
        <li>= Really necessary? Will people (automatically) update their modules?</li>
    </ul>    

	<p>Direct modification of the module:</p>
    <ul class='step'>
        <li>+ Easier to modify and manage</li>
        <li>+ Easier to apply custom logic </li>
        <li>- Can't be reused <em>as is</em> in different projects</li>
        <li>- Can't be automatically updated with mainstream</li>
        <li>= Not elegant. Limited reusability. No upstream patching.</li>
	</ul>
</div>


<div class='slide'>
	<h1 style="visibility:hidden; display:none" >Part 3 - Example42 proposals</h1>
    <img src="gfx/part-3.jpg" alt="Part 3" class="picpart">
</div>

<div class='slide'>
    <img src="gfx/min-example42.jpg" class="pic">    
	<h1>www.example42.com</h1>
	<ul class='step'>
		<li>A set of Puppet modules and sample infrastructures</li>
		<li>Status: Erratic :-) Between consolidation and experimentation</li>
		<li>Useful (hopefully) for learning and customization</li>
		<li>Various modules not standardized and "production ready", at least <em>as is</em></li>
	    <li>Multi OS support, easy to improve</li>
        <li>By default no config files management logic is forced</li>
        <li>"Made to be adapted" to custom logic and needs</li>
        <li>"SysAdmin approach" to ease integration in existing infrastrucures</li>
    </ul>
</div>

<div class='slide'>
	<h1>Addressing Interoperability Issues</h1>
	<ul class='step'>
		<li>Module are not always independent</li>
		<li>May use general (common) defines and functions (concat, replaceline...)</li>
		<li>May need resources provided by other modules (apache .conf, sysctl...)</li>
		<li>May integrate monitoring resources based on custom logic or application (munin, nagios...)</li>
        <li>May require the absence of other modules (postfix vs sendmail)</li>
	</ul>
</div>

<div class='slide'>
	<h1>Extending naming conventions...<img src="gfx/discute.gif" class="discute"></h1>
    <img src="gfx/min-box.jpg" class="pic">    
    <p>Proposed extensions:</p>
  <ul class='step'>
		<li><strong>include samba::absent</strong><br>
		Completely remove package (and Puppet managed files?)</li>
	<li><strong>include samba::disableboot</strong> <br>
    Disable  service at boot time and don't  check status  runtime</li>
		<li><strong>samba::monitor</strong> <br>
	    A standard way to define what to monitor</li>
	<li><strong>samba::backup</strong> <br>
    A standard way to define what to backup</li>
        <li><strong>samba::conf</strong> ( or samba::settings )<br>
        General purpose inline modification define for main configuration file</li>
  </ul>
  <p>(This is a call for standardization: first we should agree on needs, then on naming)</p>
</div>

<div class='slide'>
	<h1>A general monitor class<img src="gfx/discute.gif" class="discute"></h1>
	<ul class='step'>
		<li>On the module you <strong>define what you want to monitor, not how</strong></li>
      <li>Needs naming convention to allow integration between modules' sets</li>
        <li>A syntax example:
          <blockquote>
            <pre>
class postfix::monitor {

	include postfix::params

	monitor::port { "port_tcp_25":
		proto   => "tcp",
		port 	=> 25,
		enable	=> true,
	}
    
	monitor::port { "port_tcp_465":
		proto   => "tcp",
		port 	=> 465,
		enable	=> false,
	}
    
	monitor::process { "postfix_process":
		name 	=> "${postfix::params::processname}",
		enable	=> true,
	}

	monitor::plugin { "postfix_plugin":
		name 	=> "${postfix::params::plugin}",
		enable	=> false,
	}

}
          </pre>
          </blockquote>
        </li>
	</ul>
</div>

<div class='slide'>
	<h1>A general backup class <img src="gfx/discute.gif" class="discute"></h1>
	<ul class='step'>
		<li>Wrapper to define what to backup</li>
		<li>Needs naming convention... (am I obsessive?)</li>
        <li>An example:
 <pre>
class apache::backup {

	include apache::params

	backup { "apache_data": 
		frequency => daily,
		path      => "${apache::params::documentroot}",
		enabled   => true,
		host      => $fqdn,
	}
	
	backup { "apache_logs": 
		frequency => daily,
		path      => "${apache::params::logs}",
		enabled	  => false,
		host      => $fqdn,
	}
	
}

</pre>
       
        </li>
	</ul>
</div>

<div class='slide'>
	<h1>More extended classes...<img src="gfx/discute.gif" class="discute"></h1>
<p>Other extensions (ab)uses:</p>
	<ul class='step'>
		<li><strong>samba::firewall</strong><br>
		  (
	    Defines firewall rules needed for service operations )<br>
		<br>
		</li>
		<li><strong>apache::audit</strong><br>
		  (
	    Debugs / audits an application)<br>
		<br>
		</li>
		<li><strong>mailscanner::links</strong><br>
		  (
	    Defines web interfaces urls provided by the module )<br>
		<br>
		</li>
	    <li>Ideas? Suggestions?</li>
	</ul>
</div>

<div class='slide'>
	<h1>A convention for inline mods<img src="gfx/discute.gif" class="discute"></h1>
	<ul class='step'>
		<li>Inline modifications are generally not reccomended</li>
		<li>Still in some cases they can be useful or just necessary</li>
		<li>A proposed naming convention: modulename::conf (ie: samba::conf)</li>
		<li>Implementation could be via custom type or define</li>
        <li>An example with custom &quot;config&quot; define....
          <pre>
define sysctl::conf ($value) {

        require sysctl::params

        config { "sysctl_conf_${name}":
                file      => "${sysctl::params::configfile}",
                parameter  => "${name}",
                value      => "${value}",
                engine    => "augeas",
                notify    => Exec["sysctl -p"],
        }

}
</pre>
		</li>
        
	</ul>
</div>

<div class='slide'>
	<h1>A generic wrapper for inline mod engines<img src="gfx/discute.gif" class="discute"></h1>
	<ul class='step'>
		<li>Wrapper to standardize single inline modifications</li>
		<li>Can use different engines for different cases...</li>
		<li>Different engine may require value - parameters passed as single lines matching a pattern</li>
		<li>An implementation example:
<pre>
define config (
	$file='',
	$line='',
	$pattern='',
	$parameter='',
	$value='',
	$engine='',
	$source='default',
	$lens='IniFile'
	) {

	case $engine {
		
		augeas: {
		        augeas {
                		"Config_augeas_$file-$parameter":
		                context =>  "/files$file",
		                changes =>  "set $parameter $value",
		#               onlyif  =>  "get $parameter != $value", 
        		}
	        }

		file2augeas: {
		        file2augeas {
                		"Config_file2augeas_$file-$parameter":
		                file	  => "$file",
		                parameter => "$parameter",
		                value     => "$value",
		                lens      => "$lens",
        		}
	        }

		line: {
		        line {
                		"Config_line_$file-$line":
		                file	=> "$file",
		                line    => "$line",
				ensure  => "present",
				source  => "$source",
        		}
	        }

		replaceline: {
		        replaceline {
                		"Config_replaceline_$file-$line":
		                file	  => "$file",
		                pattern   => "$pattern",
		                replacement => "$line",
        		}
	        }

		default: {
		# You may define a default
	        }

	}

}
</pre>        
        </li>
	</ul>
</div>


<div class='slide'>
  <h1>Puppet for the Masses!<img src="gfx/discute.gif" class="discute"></h1>
    <img src="gfx/min-man.jpg" class="pic">    
	<p>Exploring methods to make Puppet useful also to who...<br>
	  .. 
	  does not really need it ...<br>
	... or has no intention to learn and use it.</p>
  <p><strong>One Shot</strong> Puppet runs for prototypes and appliances:</p>
<ul class='step'>
		<li><strong>Baselines</strong> for general systems setups:<br>
		-  hardening of vanilla systems,<br>
		  - best practices setups.<br>
		</li>
    <li><strong>Toasters</strong> for appliances setups:<br>
    - fast and easy way to configure  specific systems,<br>
    - automation of time consuming setup activites.</li>
  </ul>
  <p>Integrate in your Puppet modules <strong>or</strong> Run Once and forget!</p>
</div>

<div class='slide'>
  <h1>A Mail Server toaster<img src="gfx/discute.gif" class="discute"></h1>
<pre>
# Postfix + Mysql + Dovecot + MailScanner + Mailwatch + Clamav + SpamAssassin
# Example42 toaster (Variables and classes can be included via an external tool) 

# Variables to set and customize (and hide, when secret)
$postfix_mysqluser = "postfix"
$postfix_mysqlpassword = "example42"
$postfix_mysqlhost = "localhost"
$postfix_mysqldbname = "postfix"
$postfix_mynetworks = "10.42.0.0/16, 127.0.0.1/32"
$mailscanner_mysqluser = "mailwatch"
$mailscanner_mysqlpassword = "example42"
$mailscanner_mysqlhost = "localhost"
$mailscanner_mysqldbname = "mailscanner"
$mailscanner_adminuser = "admin"
$mailscanner_adminpassword = "admin"

# General setups
Exec { path => "/bin:/sbin:/usr/bin:/usr/sbin" }
import "common"

# Toaster components
include mysql
include sendmail::disable
include postfix::postfixadmin
include dovecot::mysql
include mailscanner::mailwatch
include clamav
include squirrelmail
</pre>
<br />
</div>

<div class='slide'>
	<h1 style="visibility:hidden; display:none" >Part 4 - Questions and discussions</h1>
    <img src="gfx/part-4.jpg" alt="Part 4"  class="picpart">
</div>

<div class='slide'>
	<h1 style="visibility:hidden; display:none" >Part ? - Mother nature</h1>
    <img src="gfx/mother-nature-2.jpg" alt="Part ?">
</div>



</div>
<!-- presentation -->
</body>
</html>
